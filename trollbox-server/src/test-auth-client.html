<!DOCTYPE html>
<html>
<head>
    <title>Trollbox Auth Test</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border-radius: 4px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        input {
            padding: 8px;
            margin: 5px;
            width: 300px;
            background: #333;
            border: 1px solid #555;
            color: #fff;
            border-radius: 4px;
        }
        #messages {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #555;
            padding: 10px;
            margin: 10px 0;
            background: #2a2a2a;
            border-radius: 4px;
        }
        .message {
            margin: 5px 0;
            padding: 8px;
            background: #333;
            border-radius: 4px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            background: #333;
            border-radius: 4px;
        }
        .error {
            color: #ff6b6b;
        }
        .success {
            color: #51cf66;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Trollbox Authentication Test</h1>
        
        <div class="status">
            <p>Status: <span id="status">Disconnected</span></p>
            <p>Authenticated: <span id="authStatus">No</span></p>
            <p>Username: <span id="currentUsername">-</span></p>
        </div>

        <div>
            <h3>Connection</h3>
            <button id="connectBtn">Connect</button>
            <button id="disconnectBtn" disabled>Disconnect</button>
        </div>

        <div>
            <h3>Authentication</h3>
            <input type="text" id="addressInput" placeholder="Ethereum Address (0x...)" />
            <input type="text" id="privateKeyInput" placeholder="Private Key (for testing only)" />
            <button id="authBtn" disabled>Authenticate with Signature</button>
            <button id="checkAuthBtn" disabled>Check Cached Auth</button>
        </div>

        <div>
            <h3>Username</h3>
            <input type="text" id="usernameInput" placeholder="Username" />
            <button id="setUsernameBtn" disabled>Set Username</button>
        </div>

        <div>
            <h3>Chat</h3>
            <input type="text" id="messageInput" placeholder="Type a message..." />
            <button id="sendBtn" disabled>Send</button>
        </div>

        <div id="messages"></div>
        
        <div>
            <h3>Log</h3>
            <div id="log" style="background: #1a1a1a; padding: 10px; border: 1px solid #333; height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;"></div>
        </div>
    </div>

    <script>
        let ws = null;
        let connected = false;
        let authenticated = false;
        const AUTH_MESSAGE_PREFIX = 'Sign this message to authenticate with Oikos Trollbox\n\nTimestamp: ';

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff6b6b' : type === 'success' ? '#51cf66' : '#fff';
            logDiv.innerHTML += `<div style="color: ${color}">[${time}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(text, auth = null) {
            document.getElementById('status').textContent = text;
            if (auth !== null) {
                document.getElementById('authStatus').textContent = auth ? 'Yes' : 'No';
            }
        }

        function addMessage(data) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            
            if (data.type === 'message') {
                messageDiv.innerHTML = `
                    <strong>${data.username}:</strong> ${data.content}
                    <br><small>${new Date(data.timestamp).toLocaleTimeString()}</small>
                `;
            } else {
                messageDiv.innerHTML = `<em>${JSON.stringify(data)}</em>`;
            }
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function connect() {
            ws = new WebSocket('ws://localhost:9090');
            
            ws.onopen = () => {
                connected = true;
                updateStatus('Connected', false);
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('disconnectBtn').disabled = false;
                document.getElementById('authBtn').disabled = false;
                document.getElementById('checkAuthBtn').disabled = false;
                log('Connected to WebSocket server', 'success');
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                log('Received: ' + JSON.stringify(data));
                
                switch(data.type) {
                    case 'welcome':
                        log(`Welcome! User count: ${data.userCount}`, 'success');
                        if (data.messages) {
                            data.messages.forEach(msg => addMessage(msg));
                        }
                        break;
                        
                    case 'authenticated':
                        authenticated = true;
                        updateStatus('Connected', true);
                        document.getElementById('currentUsername').textContent = data.username;
                        document.getElementById('sendBtn').disabled = false;
                        document.getElementById('setUsernameBtn').disabled = !data.canChangeUsername;
                        log(`Authenticated! Username: ${data.username}`, 'success');
                        if (data.fromCache) {
                            log('Using cached authentication', 'success');
                        }
                        break;
                        
                    case 'requireAuth':
                        log('Server requires new authentication', 'error');
                        authenticated = false;
                        updateStatus('Connected', false);
                        break;
                        
                    case 'message':
                        addMessage(data);
                        break;
                        
                    case 'error':
                        log(`Error: ${data.message}`, 'error');
                        break;
                        
                    case 'usernameChanged':
                        document.getElementById('currentUsername').textContent = data.username;
                        document.getElementById('setUsernameBtn').disabled = !data.canChangeUsername;
                        log(`Username changed to: ${data.username}`, 'success');
                        break;
                }
            };
            
            ws.onclose = () => {
                connected = false;
                authenticated = false;
                updateStatus('Disconnected', false);
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
                document.getElementById('authBtn').disabled = true;
                document.getElementById('checkAuthBtn').disabled = true;
                document.getElementById('sendBtn').disabled = true;
                document.getElementById('setUsernameBtn').disabled = true;
                log('Disconnected from server', 'error');
            };
            
            ws.onerror = (error) => {
                log(`WebSocket error: ${error}`, 'error');
            };
        }

        document.getElementById('connectBtn').onclick = connect;
        
        document.getElementById('disconnectBtn').onclick = () => {
            if (ws) {
                ws.close();
            }
        };
        
        document.getElementById('authBtn').onclick = async () => {
            const address = document.getElementById('addressInput').value;
            const privateKey = document.getElementById('privateKeyInput').value;
            
            if (!address || !privateKey) {
                log('Please enter address and private key', 'error');
                return;
            }
            
            try {
                // Create wallet from private key
                const wallet = new ethers.Wallet(privateKey);
                
                // Verify address matches
                if (wallet.address.toLowerCase() !== address.toLowerCase()) {
                    log('Address does not match private key', 'error');
                    return;
                }
                
                // Create auth message
                const timestamp = Date.now();
                const message = AUTH_MESSAGE_PREFIX + timestamp;
                
                // Sign message
                const signature = await wallet.signMessage(message);
                
                log(`Signing message: ${message}`);
                log(`Signature: ${signature}`);
                
                // Send auth message
                ws.send(JSON.stringify({
                    type: 'auth',
                    address,
                    signature,
                    message,
                    username: document.getElementById('usernameInput').value || undefined
                }));
                
            } catch (error) {
                log(`Auth error: ${error.message}`, 'error');
            }
        };
        
        document.getElementById('checkAuthBtn').onclick = () => {
            const address = document.getElementById('addressInput').value;
            
            if (!address) {
                log('Please enter address', 'error');
                return;
            }
            
            ws.send(JSON.stringify({
                type: 'checkAuth',
                address
            }));
            
            log('Checking cached authentication...');
        };
        
        document.getElementById('setUsernameBtn').onclick = () => {
            const username = document.getElementById('usernameInput').value;
            
            if (!username) {
                log('Please enter a username', 'error');
                return;
            }
            
            ws.send(JSON.stringify({
                type: 'changeUsername',
                username
            }));
        };
        
        document.getElementById('sendBtn').onclick = () => {
            const message = document.getElementById('messageInput').value;
            
            if (!message) return;
            
            ws.send(JSON.stringify({
                type: 'message',
                content: message
            }));
            
            document.getElementById('messageInput').value = '';
        };
        
        document.getElementById('messageInput').onkeypress = (e) => {
            if (e.key === 'Enter' && !document.getElementById('sendBtn').disabled) {
                document.getElementById('sendBtn').click();
            }
        };
    </script>
</body>
</html>